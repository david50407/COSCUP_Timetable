<!DOCTYPE HTML>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <title>COSCUP 2017 Timeline</title>
    <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/vis/4.20.1/vis.min.css" />
    <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/earlyaccess/notosanstc.css" />
    <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/tingle/0.11.0/tingle.min.css" />
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/vis/4.20.1/vis.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/tingle/0.11.0/tingle.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mousetrap/1.6.1/mousetrap.min.js"></script>
    <script type="text/javascript" src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
    <script type="text/javascript" src="https://unpkg.com/babel-polyfill@6.23.0/dist/polyfill.min.js"></script>
    <style>
      html, body, #visualization {
        margin: 0;
        padding: 0;
        width: 100%;
        height: 100%;
        font-family: 'Noto Sans TC', sans-serif;
      }

      body {
        font-size: 12px;
      }

      .vis-item.dayTwo {
        background-color: rgba(200, 200, 200, 0.4);
      }

      .vis-item {
        transition: height 0.3s, top 0.6s;
      }

      #visualization h1 {
        font-size: 1.2em;
        font-weight: normal;
        line-height: 1.2em;
        margin: 5px 0;
        text-overflow: ellipsis;
        overflow: hidden;
      }

      #visualization .summary {
        position: relative;
        line-height: 1em;
        max-height: 1em;
        overflow: hidden;
      }
      #visualization .summary::after {
        content: "...";
        position: absolute;
        bottom: 0;
        right: 0;
        padding-left: 40px;
        background: linear-gradient(to right, transparent, #d5ddf6 55%);
      }

      .tingle-modal-box {
        font-size: 14px;
      }

      .tingle-modal-box h3 {
        text-align: right;
        font-weight: normal;
      }
    </style>
  </head>
  <body>
    <div id="visualization"></div>

    <script type="text/babel" data-presets="es2015,stage-1">
      (async function() {
        const submissions = await fetch('https://coscup.org/2017-assets/json/submissions.json')
          .then(resp => resp.json())

        const items = submissions.map(({ start, end, room, subject, summary, community, speaker, ...sub }, idx) => ({
          start: new Date(start),
          end: new Date(end),
          summary,
          community,
          speaker,

          id: idx,
          content: subject,
          title: subject,
          group: room,
        }))
        const groups = [ ...new Set(submissions.map(({ room }) => room)) ].map(room => ({
          id: room,
          content: `Room ${room}`,
        }))
        const communities = items.reduce((communities, { start, end, community: name, ...item }) => {
          if (name === '') return communities

          if (!communities[name])
            communities[name] = {
              start,
              end,

              id: `community_${name}`,
              type: 'background',
              content: name,
              group: item.group,

              isCommunity: true,
            }

          const community = communities[name];
          if (start.getTime() < community.start.getTime())
            community.start = start
          if (end.getTime() > community.end.getTime())
            community.end = end

          return communities
        }, {})

        const modal = new tingle.modal()

        const getTime = (() => {
          const pad = (v) => v < 10 ? `0${v}` : v.toString()

          return (v) => v instanceof Date ?
            `${pad(v.getHours())}:${pad(v.getMinutes())}` :
            v.toString().replace(/2017-08-\d+T(\d+:\d+):00\+08:00/, (_, time) => time)
        })()

        const timeline = new vis.Timeline(document.getElementById('visualization'), [
          ...items,
          ...Object.values(communities),
          {
            start: '2017-08-06T09:00:00+08:00',
            end: '2017-08-06T17:10:00+08:00',
            type: 'background',
            className: 'dayTwo',

            isBackground: true,
          },
        ], groups, {
          min: '2017-08-05T08:40:00+08:00',
          max: '2017-08-06T17:10:00+08:00',
          hiddenDates: {
            start: '2017-08-05T17:10:00+08:00',
            end: '2017-08-06T09:00:00+08:00'
          },
          height: '100%',
          stack: false,
          selectable: false,
          margin: {
            item: {
              horizontal: 20,
              vertical: 60,
            },
          },
          zoomMin: 5 * 60 * 1000,
          rollingMode: {
            follow: false,
            offset: 0.5,
          },

          template(item, element, data) {
            const { start, end, content, summary } = item

            return item.isBackground ? '' : item.isCommunity ? (`
              <h1>${content}</h1>
            `) : (`
              <small>${getTime(start)} - ${getTime(end)}</small>
              <h1>${content}</h1>
            `)
          },
        })

        timeline.on('click', ({ item: id }) => {
          if (id == null) return

          const item = items[id]
          const { start, end, content, summary, speaker } = item

          modal.setContent(`
            <small>${getTime(start)} - ${getTime(end)}</small>
            <h1>${content}</h1>
            <h3>-- ${speaker.name}</h3>
            <p class="summary">${summary}</p>
          `)
          modal.open()
        })

        // record last view
        const { localStorage } = window
        if (localStorage) {
          const [start, end] = (localStorage.getItem('lastRange') || '')
            .split('#')
          if (start && end) timeline.setWindow(Number(start), Number(end), { animation: false })

          timeline.on('rangechanged', ({ start, end }) => {
            localStorage.setItem('lastRange', `${Number(start)}#${Number(end)}`)
          })
        }

        // keyboard support
        (() => {
          const animation = {
            duration: 200,
            easingFunction: 'linear',
          }

          let moving = null;
          const moveTimeline = (percent) => {
            if (moving == percent) return
            moving = percent

            const { start, end } = timeline.getWindow()
            const interval = end - start

            timeline.setWindow({
              animation,
              start: start.valueOf() - interval * percent,
              end: end.valueOf() - interval * percent,
            })

            setTimeout(() => moving = null, 200)
          }

          let zooming = null;
          const zoomTimeline = (percent) => {
            if (zooming == percent) return
            zooming = percent

            if (percent > 0)
              timeline.zoomIn(percent, { animation })
            else
              timeline.zoomOut(-percent, { animation })

            setTimeout(() => zooming = null, 200)
          }

          Mousetrap.bind('left', () => moveTimeline(0.2));
          Mousetrap.bind('right', () => moveTimeline(-0.2));
          Mousetrap.bind('up', () => zoomTimeline(0.3));
          Mousetrap.bind('down', () => zoomTimeline(-0.3));
        })()
      })()
    </script>
  </body>
</html>
